# トクノリレンタカー バックエンド仕様書

## 概要

レンタカー予約システムのバックエンド。Cloud Run + Firestore + Stripe + Resend で構成。

## 技術スタック

| 項目 | 技術 |
|------|------|
| ランタイム | Node.js 20 (Cloud Run) |
| データベース | Firebase Firestore |
| 認証 | 自前実装 (JWT + Firestore) |
| 決済 | Stripe |
| メール | Resend |
| フロントエンド | 静的HTML/CSS/JS |

---

## 機能一覧

### ユーザー向け
- 会員登録（メール確認付き）
- ログイン（新規デバイス検知時は2段階認証）
- パスワードリセット
- 予約作成（在庫自動チェック＋車両自動割り当て＋即確定）
- 予約確認・詳細表示
- キャンセル申請
- プロフィール編集
- 退会

### 管理者向け
- 管理者ログイン
- 予約一覧・詳細・ステータス変更
- 受取処理・返却処理
- 延長処理
- キャンセル承認/却下（Stripe返金処理）
- 会員一覧・詳細
- 車両クラス管理
- 料金設定
- 車両・在庫管理
- オプション管理
- 店舗設定
- 法的文書管理

### 自動処理
- リマインドメール送信（受取日前日）
- Stripe Webhook処理

---

## 仕様詳細

### 認証

| 項目 | 仕様 |
|------|------|
| 認証方式 | メール + パスワード |
| トークン | JWT (アクセストークン: 1時間 / リフレッシュトークン: 30日) |
| パスワード | bcrypt (cost=12) |
| 2段階認証 | 新規デバイス/IP検知時のみ（6桁コード、有効期限10分） |

### 予約

| 項目 | 仕様 |
|------|------|
| 予約確定 | 在庫があれば即確定（自動承認） |
| 車両割り当て | 予約時に空いている車両を自動割り当て |
| キャンセル | 管理者承認制 → 承認後にStripe返金 |
| リマインド | 受取日前日にメール送信 |

### キャンセル料金

| 時期 | 料率 |
|------|------|
| 7日前まで | 0% |
| 3〜6日前 | 30% |
| 前日〜当日 | 50% |
| 無断キャンセル | 100% |

### 決済

| 項目 | 仕様 |
|------|------|
| 決済方式 | Stripe Checkout Session |
| 対応 | クレジットカード / 現地払い |
| 返金 | 管理者がキャンセル承認時にAPI経由で実行 |

---

## ステータス定義

### 予約ステータス

| ステータス | 説明 |
|------------|------|
| `pending_payment` | 決済待ち（Stripe Checkout中） |
| `confirmed` | 確定（決済完了 or 現地払い選択） |
| `picked_up` | 受取済み（レンタル中） |
| `returned` | 返却済み |
| `cancel_requested` | キャンセル申請中 |
| `cancelled` | キャンセル確定 |
| `no_show` | 無断キャンセル |

### 車両ステータス

| ステータス | 説明 |
|------------|------|
| `available` | 貸出可能 |
| `rented` | レンタル中 |
| `maintenance` | メンテナンス中 |

---

## セキュリティ要件

1. **入力バリデーション**: 全APIエンドポイントで実施
2. **認証チェック**: JWT検証 + デバイスフィンガープリント
3. **レート制限**: ログイン試行 5回/分、API全体 100回/分
4. **CORS**: フロントエンドドメインのみ許可
5. **Stripe Webhook**: 署名検証必須
6. **SQLインジェクション**: Firestoreは構造上安全だが、クエリ構築時に注意
7. **XSS**: レスポンスはJSONのみ（HTMLレンダリングなし）

---

## エラーハンドリング方針

### Stripe同期

1. **決済失敗時**: 予約は作成しない、エラーメッセージを返す
2. **Webhook遅延**: 予約は`pending_payment`で作成、Webhookで`confirmed`に更新
3. **返金失敗時**: ログ出力 + 管理者に通知メール + 手動対応フラグ
4. **二重決済防止**: idempotencyKey使用

### フォールバック

1. **Resendエラー**: リトライ3回、失敗時はログ + 管理者通知
2. **Firestore一時障害**: エクスポネンシャルバックオフでリトライ
3. **車両割り当て競合**: トランザクション使用、失敗時は再試行

---

## 次のドキュメント

- `DATABASE.md` - Firestoreスキーマ設計
- `API.md` - API仕様
- `CLAUDE.md` - Claude Code向け指示書
