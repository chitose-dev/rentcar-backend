# トクノリレンタカー バックエンド仕様書

## 概要

レンタカー予約システムのバックエンド。Cloud Run + Firestore + Stripe + Resend で構成。

## 技術スタック

| 項目 | 技術 |
|------|------|
| ランタイム | Node.js 20 (Cloud Run) |
| データベース | Firebase Firestore |
| 認証 | 自前実装 (JWT + Firestore) |
| 決済 | Stripe |
| メール | Resend |
| フロントエンド | 静的HTML/CSS/JS |

---

## 機能一覧

### ユーザー向け
- 会員登録（メール確認付き）
- ログイン（新規デバイス検知時は2段階認証）
- パスワードリセット
- 予約作成（在庫自動チェック＋車両自動割り当て＋即確定）
- 予約確認・詳細表示
- キャンセル申請
- プロフィール編集
- 退会

### 管理者向け
- 管理者ログイン
- 予約一覧・詳細・ステータス変更
- 受取処理・返却処理
- 延長処理
- キャンセル承認/却下（Stripe返金処理）
- 会員一覧・詳細
- 車両クラス管理
- 料金設定
- 車両・在庫管理
- オプション管理
- 店舗設定
- 法的文書管理

### 自動処理
- リマインドメール送信（受取日前日）
- Stripe Webhook処理

---

## 仕様詳細

### 認証

| 項目 | 仕様 |
|------|------|
| 認証方式 | メール + パスワード |
| トークン | JWT (アクセストークン: 1時間 / リフレッシュトークン: 30日) |
| パスワード | bcrypt (cost=12) |
| リフレッシュトークン保存 | SHA256ハッシュ（検証時に比較のみ） |
| 2段階認証 | 新規デバイス/IP検知時のみ（6桁コード、有効期限10分） |
| ログアウト | 現在のセッションを無効化、リフレッシュトークン削除 |
| 管理者認証 | 同上（2段階認証は常に有効、デバイス検知なし） |

### 管理者2段階認証

| 項目 | 仕様 |
|------|------|
| 発動条件 | 毎回のログイン時（デバイス検知なし） |
| 認証方式 | メールでの6桁コード |
| 有効期限 | 10分 |
| 試行回数 | 5回まで（超過でアカウントロック15分） |

### リフレッシュトークンローテーション

| 項目 | 仕様 |
|------|------|
| ローテーション | トークン更新時に新しいリフレッシュトークンを発行 |
| 旧トークン | 即時無効化（再利用検知時は全セッション無効化） |
| 不正検知 | 同一リフレッシュトークンの複数回使用を検知 |
| アラート | 不正検知時にユーザーへメール通知 |

**フロー:**
1. クライアントがリフレッシュトークンでアクセストークンを要求
2. サーバーが新しいアクセストークン + 新しいリフレッシュトークンを発行
3. 旧リフレッシュトークンはDB上で無効化
4. 無効化済みトークンが再利用された場合、セキュリティ侵害と判断
5. 該当ユーザーの全セッションを無効化 + 通知メール送信

### トークン有効期限

| トークン種別 | 有効期限 | 更新方法 |
|-------------|---------|---------|
| アクセストークン | 1時間 | リフレッシュトークンで更新 |
| リフレッシュトークン | 30日 | ログイン時に新規発行 |
| メール確認コード | 24時間 | 再送信で新規発行 |
| パスワードリセットコード | 1時間 | 再送信で新規発行 |
| 2FAコード | 10分 | 再送信で新規発行 |
| Stripe Checkout Session | 30分 | 予約を再作成 |

### セッション管理

| 項目 | 仕様 |
|------|------|
| 同時ログイン | 複数デバイスで許可 |
| セッション上限 | 1ユーザーあたり最大10セッション |
| 上限超過時 | 最も古いセッションを自動削除して新規作成 |
| 自動ログアウト | リフレッシュトークン期限切れ時 |
| 強制ログアウト | パスワード変更時に全セッション無効化 |

### 予約

| 項目 | 仕様 |
|------|------|
| 予約確定 | 在庫があれば即確定（自動承認） |
| 車両割り当て | 予約時に空いている車両を自動割り当て |
| キャンセル | 管理者承認制 → 承認後にStripe返金 |
| リマインド | 受取日前日にメール送信 |

### 予約ID形式

| 項目 | 仕様 |
|------|------|
| 形式 | `R{YYYYMMDD}{連番2桁}` |
| 連番 | 日ごとにリセット、01から開始 |
| 例 | 2026年2月13日の3件目 → `R2026021303` |
| 競合時 | トランザクション内でインクリメント（Firestore標準動作、最大5回自動リトライ） |
| 上限 | 99件/日（超過時は3桁に拡張: `R20260213100`） |

**採番ロジック:**
1. トランザクション内で`/counters/reservation_{YYYYMMDD}`ドキュメントを取得
2. `currentCount + 1`で連番を決定
3. トランザクション競合時は自動リトライ（Firestore標準動作、最大5回）
4. 連番が100以上の場合は3桁表示（例: `R20260213100`）

**カウンタードキュメント:**
```javascript
// /counters/reservation_{YYYYMMDD}
{
  date: "2026-02-13",
  currentCount: 3,
  updatedAt: Timestamp
}
```

### キャンセル料金

| 時期 | 料率 |
|------|------|
| 7日前まで | 0% |
| 3〜6日前 | 30% |
| 前日〜当日 | 50% |
| 無断キャンセル | 100% |

### 延長処理

| 項目 | 仕様 |
|------|------|
| 延長タイミング | レンタル中（`picked_up`ステータス）のみ可能 |
| 延長上限 | 元の返却予定日から最大30日まで |
| 料金計算 | 延長日数 × 1日あたり料金（既存プランの日割り計算） |
| 決済 | 差額を現地払い or 追加Stripe決済 |
| 車両確認 | 延長期間中に他の予約が入っていないことを確認 |
| 在庫影響 | 延長承認時に延長期間の在庫を確保 |

**延長フロー:**
1. 管理者が管理画面から延長処理を開始
2. 新しい返却日時を指定
3. システムが車両の空き状況を確認
4. 差額料金を計算・表示
5. 管理者が確定 → 予約更新 + 必要に応じて追加決済

### 保険オプション

| プラン | 日額 | 免責金額 | 補償内容 |
|--------|------|----------|----------|
| `none` | ¥0 | 全額自己負担 | 基本補償なし |
| `standard` | ¥1,100 | ¥50,000 | 対人・対物・車両保険 |
| `premium` | ¥2,200 | ¥0 | 対人・対物・車両保険 + NOC補償 + ロードサービス |

**補償詳細:**
- **対人補償**: 無制限
- **対物補償**: 無制限
- **車両補償**: 時価額まで
- **NOC補償（premiumのみ）**: 休業補償・ノンオペレーションチャージ免除

### 決済

| 項目 | 仕様 |
|------|------|
| 決済方式 | Stripe Checkout Session |
| 対応 | クレジットカード / 現地払い |
| 返金 | 管理者がキャンセル承認時にAPI経由で実行 |

---

## ステータス定義

### 予約ステータス

| ステータス | 説明 |
|------------|------|
| `pending_payment` | 決済待ち（Stripe Checkout中） |
| `confirmed` | 確定（決済完了 or 現地払い選択） |
| `picked_up` | 受取済み（レンタル中） |
| `returned` | 返却済み |
| `cancel_requested` | キャンセル申請中 |
| `cancelled` | キャンセル確定 |
| `no_show` | 無断キャンセル |

### ステータス遷移図

```
pending_payment ──(Webhook: checkout.session.completed)──→ confirmed
pending_payment ──(30分期限切れ / Webhook: expired)──→ [削除]

confirmed ──(受取処理)──→ picked_up
confirmed ──(キャンセル申請)──→ cancel_requested
confirmed ──(無断キャンセル処理)──→ no_show

picked_up ──(返却処理)──→ returned

cancel_requested ──(承認)──→ cancelled
cancel_requested ──(却下)──→ confirmed
```

**不可逆遷移:** `returned`, `cancelled`, `no_show` は最終状態

### 退会後データ処理

| 処理 | タイミング | 内容 |
|------|----------|------|
| 即時 | 退会時 | `status='withdrawn'`、全セッション無効化、デバイス削除 |
| 30日後 | Cloud Scheduler | 予約履歴の個人情報匿名化 |

**匿名化処理:**
- `userName` → `"退会済みユーザー"`
- `userEmail` → `null`
- `userPhone` → `null`

**Cloud Scheduler設定:**
- 名前: `anonymize-withdrawn-users`
- 頻度: `0 3 * * *`（毎日3:00 JST）
- ターゲット: `/api/scheduler/anonymize-withdrawn-users`

### 車両ステータス

| ステータス | 説明 |
|------------|------|
| `available` | 貸出可能 |
| `rented` | レンタル中 |
| `maintenance` | メンテナンス中 |

---

## セキュリティ要件

1. **入力バリデーション**: 全APIエンドポイントで実施
2. **認証チェック**: JWT検証 + デバイスフィンガープリント
3. **レート制限**: ログイン試行 5回/分、API全体 100回/分
4. **CORS**: フロントエンドドメインのみ許可
5. **Stripe Webhook**: 署名検証必須
6. **SQLインジェクション**: Firestoreは構造上安全だが、クエリ構築時に注意
7. **XSS**: レスポンスはJSONのみ（HTMLレンダリングなし）

---

## エラーハンドリング方針

### Stripe同期

1. **決済失敗時**: 予約は作成しない、エラーメッセージを返す
2. **Webhook遅延**: 予約は`pending_payment`で作成、Webhookで`confirmed`に更新
3. **返金失敗時**: ログ出力 + 管理者に通知メール + 手動対応フラグ
4. **二重決済防止**: idempotencyKey使用

### フォールバック

1. **Resendエラー**: リトライ3回、失敗時はログ + 管理者通知
2. **Firestore一時障害**: エクスポネンシャルバックオフでリトライ
3. **車両割り当て競合**: トランザクション使用、失敗時は再試行

---

## メールテンプレート一覧

| テンプレート名 | 件名 | トリガー | 内容 |
|---------------|------|---------|------|
| `email-verification` | 【トクノリレンタカー】メールアドレス確認 | 会員登録時 | 確認コード（6桁）、有効期限（24時間） |
| `login-2fa` | 【トクノリレンタカー】ログイン認証コード | 新規デバイスログイン時 | 認証コード（6桁）、有効期限（10分） |
| `password-reset` | 【トクノリレンタカー】パスワードリセット | パスワードリセット要求時 | リセットコード（6桁）、有効期限（1時間） |
| `reservation-confirmed` | 【トクノリレンタカー】予約確定のお知らせ | 予約確定時（決済完了 or 現地払い選択） | 予約詳細、受取場所、注意事項 |
| `reservation-reminder` | 【トクノリレンタカー】明日のご予約について | 受取日前日 | 予約詳細、持ち物リスト、店舗アクセス |
| `cancel-requested` | 【トクノリレンタカー】キャンセル申請受付 | キャンセル申請時 | キャンセル料目安、処理予定 |
| `cancel-approved` | 【トクノリレンタカー】キャンセル完了 | キャンセル承認時 | 返金額、返金処理予定 |
| `cancel-rejected` | 【トクノリレンタカー】キャンセル申請について | キャンセル却下時 | 却下理由、問い合わせ先 |
| `admin-refund-failed` | 【要対応】返金処理失敗 | 返金API失敗時（管理者宛） | 予約ID、金額、エラー詳細、対応手順 |
| `admin-alert` | 【要確認】システムアラート | 重要エラー発生時（管理者宛） | エラー種別、詳細、推奨対応 |

### テンプレート変数

共通変数:
- `{{shopName}}` - 店舗名
- `{{shopPhone}}` - 店舗電話番号
- `{{shopEmail}}` - 店舗メールアドレス
- `{{currentYear}}` - 現在の年（著作権表記用）

予約関連:
- `{{userName}}` - 会員名
- `{{reservationId}}` - 予約ID
- `{{carClassName}}` - 車両クラス名
- `{{vehicleModel}}` - 車種
- `{{licensePlate}}` - ナンバープレート
- `{{pickupAt}}` - 受取日時
- `{{returnAt}}` - 返却日時
- `{{totalPrice}}` - 合計金額
- `{{refundAmount}}` - 返金額
- `{{cancellationFee}}` - キャンセル料

---

## 次のドキュメント

- `DATABASE.md` - Firestoreスキーマ設計
- `API.md` - API仕様
- `CLAUDE.md` - Claude Code向け指示書
